name: Configuration Validation

on:
  push:
    paths:
      - 'config/**'
      - 'alloy/**'
      - 'grafana/**'
      - 'docker-compose.yml'
      - '.env.example'
  pull_request:
    paths:
      - 'config/**'
      - 'alloy/**'
      - 'grafana/**'
      - 'docker-compose.yml'
      - '.env.example'

jobs:
  validate-prometheus:
    name: Validate Prometheus Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Prometheus Configuration
        run: |
          docker run --rm -v ${{ github.workspace }}/config:/config --entrypoint promtool prom/prometheus:latest check config /config/prometheus.yml
          echo "✅ Prometheus configuration is valid"

      - name: Validate Alert Rules
        run: |
          if [ -f "config/rules/marketsage-alerts.yml" ]; then
            docker run --rm -v ${{ github.workspace }}/config/rules:/rules --entrypoint promtool prom/prometheus:latest check rules /rules/marketsage-alerts.yml
            echo "✅ Alert rules are valid"
          else
            echo "❌ Alert rules file not found"
            exit 1
          fi

  validate-loki:
    name: Validate Loki Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Loki Configuration
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/config:/config \
            grafana/loki:latest \
            -config.file=/config/loki.yml \
            -verify-config

  validate-alloy:
    name: Validate Alloy Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate and Format Alloy Configuration
        run: |
          # Check syntax and formatting
          docker run --rm \
            -v ${{ github.workspace }}/alloy/config:/config \
            grafana/alloy:latest \
            fmt /config/config.alloy --write=false
          echo "✅ Alloy configuration syntax is valid"

  validate-alertmanager:
    name: Validate Alertmanager Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Alertmanager Configuration
        run: |
          docker run --rm -v ${{ github.workspace }}/config:/config --entrypoint amtool prom/alertmanager:latest check-config /config/alertmanager.yml
          echo "✅ Alertmanager configuration is valid"

  validate-grafana:
    name: Validate Grafana Assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Dashboard JSON
        run: |
          for dashboard in grafana/dashboards/*.json; do
            if [ -f "$dashboard" ]; then
              echo "Validating $dashboard"
              python -m json.tool "$dashboard" > /dev/null
              echo "✅ $dashboard is valid"
            fi
          done

      - name: Validate Provisioning Configs
        run: |
          for config in grafana/provisioning/**/*.yml; do
            if [ -f "$config" ]; then
              echo "Validating $config"
              python -c "import yaml; yaml.safe_load(open('$config'))"
              echo "✅ $config is valid YAML"
            fi
          done

  validate-docker-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Docker Compose
        run: |
          # Install Docker Compose via direct download
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
      
      - name: Validate Docker Compose syntax
        run: |
          cp .env.example .env
          docker-compose config --quiet
          echo "✅ Docker Compose configuration is valid"

      - name: Check for required services
        run: |
          # Ensure all required services are defined
          required_services=("prometheus" "loki" "grafana" "alloy" "alertmanager" "postgres-exporter" "redis-exporter" "node-exporter" "cadvisor")
          
          for service in "${required_services[@]}"; do
            if docker-compose config --services | grep -q "^$service$"; then
              echo "✅ Service $service is defined"
            else
              echo "❌ Service $service is missing"
              exit 1
            fi
          done

  security-check:
    name: Security Configuration Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for hardcoded secrets
        run: |
          # Check for potential secrets in config files
          if grep -r "password.*=" config/ || grep -r "token.*=" config/ || grep -r "key.*=" config/; then
            echo "⚠️ Found potential hardcoded secrets in configuration files"
            echo "Please ensure these are properly externalized"
          else
            echo "✅ No hardcoded secrets found in configuration files"
          fi

      - name: Validate secrets structure
        run: |
          # Check if secrets.example directory exists and has required files
          required_secrets=("grafana_admin_password.txt" "smtp_password.txt" "slack_webhook_url.txt" "prometheus_basic_auth.txt")
          
          for secret in "${required_secrets[@]}"; do
            if [ -f "secrets.example/$secret" ]; then
              echo "✅ Example secret file $secret exists"
            else
              echo "❌ Example secret file $secret is missing"
              exit 1
            fi
          done

  performance-check:
    name: Performance Configuration Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check resource configurations
        run: |
          # Check if reasonable retention periods are set
          if grep -q "retention" config/prometheus.yml; then
            echo "✅ Prometheus retention configured"
          fi
          
          if grep -q "retention" config/loki.yml; then
            echo "✅ Loki retention configured"
          fi

      - name: Validate scrape intervals
        run: |
          # Check for reasonable scrape intervals
          if grep -q "scrape_interval.*[0-9]\+s" config/prometheus.yml; then
            echo "✅ Scrape intervals are configured"
          fi